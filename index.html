<!DOCTYPE html>
<html lang="en" ng-app="test">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
    
  <script src="lib/player/jquery.js"></script>
  
  <script src="lib/angular.min.js"></script>
  <script src="lib/angular-sanitize.min.js"></script>
  <script src="lib/tv4.min.js"></script>
  <script src="lib/ObjectPath.js"></script>
  
  <script src="lib/schema-form.min.js"></script>
  <script src="lib/bootstrap-decorator.js"></script>
  
  <script src="lib/player/mediaelement-and-player.min.js"></script>
  <link rel="stylesheet" href="lib/player/mediaelementplayer.css" />
  
  <link rel="stylesheet" href="lib/bootstrap/css/bootstrap.min.css" />
  <script src="lib/bootstrap/js/bootstrap.min.js"></script>
  
  
  <script type="text/javascript">
  
  function PeriodicPlayer(player) 
  { 
    this.player = player;    
    this.currentStopListener = null;

    this.setPeriod = function(start,end) 
    {
      player.pause();
      if(this.currentStopListener != null) {
        this.player.media.removeEventListener("timeupdate", this.currentStopListener, false);
      }
      
      this.currentStopListener = function() {
       if (this.currentTime > end) {
            player.setCurrentTime(start);
            this.pause();
        }
      };
      
      player.media.addEventListener("timeupdate", this.currentStopListener, false);
      player.setCurrentTime(start);
    }
  }
  
  var playerGlobal;
  $( document ).ready(function() {
    $('#player').mediaelementplayer({
      success: function(media, node, player) {
        $('#' + node.id + '-mode').html('mode: ' + player.pluginType);
        
        media.addEventListener('loadedmetadata', function() {
          playerGlobal = new PeriodicPlayer(player);
        });
      }
    });
  });

  </script>
  
  <script type="text/javascript">
    var app = angular.module('test', ['schemaForm']);
    
    app.controller('MainController', function($rootScope, $scope, $compile) {
    
      $scope.model = {};
      $scope.selected = null;
    
      $scope.openFile = function(input) {
      
        var reader = new FileReader();
        
        reader.onload = function(){
          jsonData = JSON.parse(reader.result);
          $scope.model = jsonData;
          
          for (var i = 0; i < jsonData.intervals.length; i++) 
          {
            var v = jsonData.intervals[i];
            if (typeof v.labels === 'undefined') {
              v.labels = {};
            }
            $scope.addPeriod(v);
          }
          
          $('[data-toggle="tooltip"]').tooltip();
        };
        reader.readAsText(input.files[0]);
      };
      
      $scope.addPeriod = function(data) 
      {
        var video_offset = 12.993253731;
        var log_offset = 98.408;
        var offset = video_offset - log_offset;
        
      
        max_time = playerGlobal.player.media.duration;
        width = Math.min((data.end-data.begin)/max_time*100, 100);
        
        var str = '<a href="#" class="'+data.type+'" style="width:'+width+'%" data-toggle="tooltip" title="'+data.label+'"></a>';
        var o = $compile(str)($scope);

        o[0].onclick = function() {
          playerGlobal.setPeriod(data.begin + offset, data.end + offset);
          $rootScope.$broadcast('setPeriod', data);
          o.addClass("selected");
          
          if($scope.selected != null) {
            $scope.selected.removeClass("selected");
          }
          $scope.selected = o;
          
          /*
          for (var i = 0; i < $scope.model.intervals.length; i++) 
          {
            var v = $scope.model.intervals[i];
            for(var j = 0; j < v.labels.labels.length; j++) {
              var l = v.labels.labels[j];
            }
          }*/
          
        };
        
        angular.element(document.getElementById('timeline')).append(o);
      };
      
      $scope.save = function(event) {
        var str = JSON.stringify($scope.model, null, '  ');
        console.log(str);
        event.target.href = 'data:text/json;charset=utf8,' + encodeURIComponent(str);
      }
    });
    
    
    app.controller('FormController', function($scope) {
      
      
      var labelMap = [
        {"value":"pushed",   "name": "<b>pushed</b> by opponent while kicking"},
        {"value":"fall",     "name": "<b>fall</b> after kick"},
        {"value":"ballmiss", "name": "kick empty space just after ball has left"},
        {"value":"touch",    "name": "<b>touch</b> the ball before kick"},
        {"value":"moved",    "name": "<b>moved</b> ball by the kick"},
        {"value":"miss",     "name": "ball was <b>not moved</b> by the kick"},
        {"value":"ghost",    "name": "empty space kick"}
      ];
      
      var myTitle = "Labels for different kick actions";
      
      
      $scope.schema = {
        "type" : "object", 
        "properties": {
          "labels": {
            "type": "array", 
            "title": myTitle,
            "items": {"type": "string", "enum": labelMap.map(i => i.value)}
          },
          "comment": {"type": "string", "title": "Comment"}
        }
      };
      
      $scope.form = [
        {
          "key": "labels",
          "type": "checkboxes",
          "titleMap": labelMap
        },
        {
          "key": "comment",
          "type": "textarea",
          "placeholder": "Make a comment"
        }
      ];

      $scope.model = {};
      
      /*
      $scope.onSubmit = function(form) {
      
        $scope.$broadcast('schemaFormValidate');
        
        if (form.$valid) {
          x = JSON.stringify($scope.model);
          v = 3;
          
          tmp = '{"labels":["fall after kick","touch the ball before kick","kick successful"],"comment":"ewfwefw"}';
        }
      }*/
  
      $scope.$on('setPeriod', function(event, data) {
          $scope.model = data.labels;
          $scope.$apply();
      });
  
    });
  </script>
  
  </code>
  
<style>

body {
  padding-top: 50px;
}

.timeline {
  width: 100%;
  height: 30px;
  border: solid 1px #999;
  background-color:#eee;
  margin-left: auto;
  margin-right: auto;
  margin-top:1%;
  clear: both;
}

.timeline a {
  display: inline-block;
  border:solid 0px #000;
  margin:0px;
  padding:0px;
  width:100%;
  height:100%;
}

.timeline a.button {
  background-color:#66a;
}

.timeline a.blank {
  background-color:none;
}

.timeline a.selected {
  background-color:#f00;
}

</style>
  
</head>

<body>

<div class="container-fluid" ng-controller="MainController">

  <div class="row">
    
    <div class="col-sm-2">
      <div ng-controller="FormController"> 
        <form name="labels" sf-schema="schema" sf-form="form" sf-model="model" ng-submit="onSubmit(labels)"></form>
      </div>
    </div>
    
    <div class="col-sm-7">
        <video src="./log/20150426-Game-NaoDevils/half1.MP4" width="640" height="480" style="width: 100%; height: 100%;" id="player"></video>
    </div>
    
    <div class="col-sm-3">
      <canvas id="canvas" width="7400" height="10400" style="width: 100%; height: 100%;"></canvas>
    </div>
  </div>

  <div class="row">
    
    <div class="col-sm-12">
      <div id="timeline" class="timeline"></div>

      <input type='file' onchange="angular.element(this).scope().openFile(this)">
      <a ng-click="save($event)" download="labels.json" href="#">Export</a>
    </div>
  </div>
  
</div>
<div style="display:none;">
  <img id="nao" src="nao.png">
</div>
<script>
function draw() {
  var canvas = document.getElementById('canvas');
  if (canvas.getContext){
    var width = canvas.width;
    var height = canvas.height;

    var xOwnGround = 9000;
    var xOppGround = 700;
    var yRightBorder = 6000;
    var yLeftBorder = 700;

    var ctx = canvas.getContext('2d');
      ctx.beginPath();
      ctx.rect(0,0,7400,10400);
      ctx.fillStyle = '#00AA00';
      ctx.fill();
      //Field Borders      
      ctx.rect(yLeftBorder,xOppGround,yRightBorder,xOwnGround)
      ctx.lineWidth = 50;
      ctx.strokeStyle = 'white';
      ctx.stroke();

      //Center Line
      ctx.beginPath();
      ctx.moveTo(yLeftBorder, 10400/2);
      ctx.lineTo(7400-700, 10400/2);
      ctx.stroke();
      //Opp Penalty  Mark
      ctx.translate((width/2),(height/2));
      ctx.beginPath();
      ctx.arc(0, -1300, 50, 0, 2 * Math.PI, false);
      ctx.fillStyle = 'white';
      ctx.fill();
      ctx.stroke();
      //Own Penalty  Mark
      ctx.beginPath();
      ctx.arc(0, 1300, 50, 0, 2 * Math.PI, false);
      ctx.fillStyle = 'white';
      ctx.fill();
      ctx.stroke();
      //Circle
      ctx.beginPath();
      ctx.arc(0, 0, 700, 0, 2 * Math.PI, false);
      ctx.stroke();
      //Own Goal Posts
      ctx.beginPath();
      ctx.arc(750, 4500, 50, 0, 2 * Math.PI, false);
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(-750, 4500, 50, 0, 2 * Math.PI, false);
      ctx.stroke();
      //Own Goal
      ctx.beginPath();
      ctx.moveTo(750, 4500);
      ctx.lineTo(750, 4500+500);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(-750, 4500);
      ctx.lineTo(-750, 4500+500);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(-750, 4500+500);
      ctx.lineTo(750, 4500+500);
      ctx.stroke();
      //Opp Goal Posts
      ctx.beginPath();
      ctx.arc(750, -4500, 50, 0, 2 * Math.PI, false);
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(-750, -4500, 50, 0, 2 * Math.PI, false);
      ctx.stroke();
      //Opp Goal
      ctx.beginPath();
      ctx.moveTo(750, -4500);
      ctx.lineTo(750, -4500-500);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(-750, -4500);
      ctx.lineTo(-750, -4500-500);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(-750, -4500-500);
      ctx.lineTo(750, -4500-500);
      ctx.stroke();

      //Own Penalty Area
      ctx.beginPath();
      ctx.moveTo(1100, 4500);
      ctx.lineTo(1100, 4500-500);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(-1100, 4500);
      ctx.lineTo(-1100, 4500-500);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(-1100, 4500-500);
      ctx.lineTo(1100, 4500-500);
      ctx.stroke();

      //Opp Penalty Area
      ctx.beginPath();
      ctx.moveTo(1100, -4500);
      ctx.lineTo(1100, -4500+500);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(-1100, -4500);
      ctx.lineTo(-1100, -4500+500);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(-1100, -4500+500);
      ctx.lineTo(1100, -4500+500);
      ctx.stroke();

      var image = document.getElementById("nao");
      //length: 557, height = 865
      ctx.scale(0.7,0.7);
      ctx.rotate(-90*Math.PI/180);
      ctx.drawImage(image, (-557/2)-450, (-865/2)); // consider the rotation
      
  }
}

draw();
</script>
</body>
</html>